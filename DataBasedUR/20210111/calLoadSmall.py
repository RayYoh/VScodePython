import numpy as np
import RV2V
k = np.array([[-0.508355458, -0.010221245, 0.001899991, 0.017937002, -0.89303229, -0.078759786],
                  [0.01629597, -0.509286966, 0.003531495, 0.890626257, 0.034062921, -0.107769097],
                  [-0.003018283, 0.002707507, 0.167344678, 0.013296802, 5.05802E-05, 0.003378879],
                  [-0.00482948, 0.670421448, -0.009244749, -2.482150596, -0.020502753, 0.124676258],
                  [-0.678125117, -0.022025622, 0.004429708, 0.080445601, -2.492087999, -0.123587686],
                  [0.000117831, 0.000621971, -0.000255144, -0.000579705, 0.002064402, 0.777330755]])
# V0 = [1990.05,1853.64,2436.83,1759.64,1720.28,1914.06]

V = np.array([[1940,1842.04,2438.96,1755.07,1748.66,1918.33],[1979.68,1898.19,2425.23,1785.58,1726.99,1922.91], #[1987.92,1853.03,2394.1,1760.86,1722.72,1919.86],[2006.23,1806.95,2437.74,1734.92,1711.12,1918.03],
            [2019.96,1823.73,2459.72,1744.69,1703.19,1919.25],[1988.22,1806.34,2454.53,1735.23,1720.89,1917.42],
            [2022.4,1863.4,2467.65,1766.36,1702.88,1921.08],[1952.51,1824.04,2416.99,1745.3,1741.33,1917.11]])
V0 = np.array([[1989.26092624, 1856.18455229, 2438.63260211, 1757.63199822, 1718.09624644, 1918.89437554] for _ in
                   range(len(V))])
F = np.dot(V - V0, np.transpose(k))

'''
F0 = np.array([[ 2.3125021,1.9914975  , 1.7524029 , -2.4644682  , 3.7567549 ,0],
                [ 0.9011766 , -0.543674   , 1.3080753  , 0.16366085 , 2.2697635,0 ],
                [-1.2239112  , 1.3033905  , 3.3303065  ,-1.954696  , -1.6798599,0 ],
                [ 0.2714331 ,  2.382842   , 2.719823  , -2.9493058  , 0.1297376 ,0],
                 [-1.5883793 , -0.10654241  ,3.3815556  ,-0.3501309 ,-2.800239 ,0 ],
                 [ 1.3712803  , 1.1837742  , 0.93664855 ,-1.2729663  , 0.852337 ,0 ]])
'''
F0 =np.array([[2.483465,2.08129,1.818075,-2.586285,4.307795,1.25225],[0.8052115,-0.625299,1.37625,0.5381505,2.186945,0.8295565],
              [1.018205,-1.69753,3.40287,1.29168,0.927781,-0.004104894],[0.5320195,2.44996,2.665215,-3.28746,0.7306455,0.4000235],
              [-1.56007,0.1913365,2.862585,-0.0259296,-2.189115,-0.09324045],[1.375275,1.374435,1.06716,-1.408635,0.735724,0.4148175]])
print('原始F：\n',F)
# F = F-F0
print('减去零点：\n',F)
TCPRv = np.array([[0.183716,1.52171,-0.520186],[1.15273,-0.136958,-0.4721565],[-2.48993,0.0906004,-0.90898],
               [-1.62383,-1.60848,0.938058],[2.61315,0.0570654,0.899956],[-1.30342,-0.344358,1.8533]])
Rsb = RV2V.RV2RM(TCPRv)
R = np.transpose(Rsb[0])
for i in range(1,len(Rsb)):
    R = np.vstack((R,np.transpose(Rsb[i])))
FT = np.transpose(F)[0:3,:]
MT = np.transpose(F)[3:,:]
P = FT[:,0:1]
Q = MT[:,0:1]
for i in range(1,len(TCPRv)):
    P = np.vstack((P,FT[:,i:i+1]))
    Q = np.vstack((Q, MT[:, i:i + 1]))
RT = np.transpose(R)
Mat_R = np.dot(RT,R)
Mat_R_I = np.linalg.inv(Mat_R)
h = np.dot(np.dot(Mat_R_I,RT),P)
print('重力：\n',h)

H = np.zeros((3*len(TCPRv),3))
for i in range(len(TCPRv)):
    Gx = P[3*i]
    Gy = P[3*i+1]
    Gz = P[3*i+2]
    H[3*i,1] = Gz
    H[3*i,2] = -Gy
    H[3*i+1,0] = -Gz
    H[3 * i + 1, 2] = Gx
    H[3 * i + 2, 0] = Gy
    H[3*i+2,1] = -Gx
HT = np.transpose(H)
MatH = np.dot(HT,H)
MatHI = np.linalg.inv(MatH)
l = np.dot(np.dot(MatHI,HT),Q)
print(l)

testF = np.dot(R,h)
print(P-testF)